<!-- layouts/shortcodes/timeline.html -->
{{- $src := .Get "src" -}}
{{- $title := .Get "title" | default "Timeline" -}}
{{- $collapse := .Get "collapse" | default "false" -}}
{{- $open := .Get "open" | default "true" -}}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<section class="sx-timeline-root"
  data-src="{{ $src }}"
  data-title="{{ $title }}"
  data-collapse="{{ $collapse }}"
  data-open="{{ $open }}">
  <!-- container will be filled by JS -->
</section>

<style>
/* === Treasure-map Timeline — ONLY CSS === */
/* Fancy fonts for headings/cards */
@import url('https://fonts.googleapis.com/css2?family=Pirata+One&family=Cinzel:wght@400;600;700&display=swap');

/* ----- Theme tokens (scoped) ----- */
.sx-timeline-root{
  --bg:#fdf6e3; --fg:#333; --muted:#5b4a2f;
  --border:#d9c9a3; --hair:#d7c7a1;
  --card:#fff8dc; --shadow:0 6px 14px rgba(0,0,0,.18);
  --line:#8b4513; --node:#cfa046;

  --edu:#2c6a9e; --work:#b87a36; --res:#1e7a1e; --award:#7c2d12; --other:#5b4db1;
}
@media (prefers-color-scheme: dark){
  .sx-timeline-root{
    --bg:#2b2b2b; --fg:#f5deb3; --muted:#e4d4a5;
    --border:#4b4b4b; --hair:#534b3c;
    --card:#3c3a34; --shadow:0 6px 18px rgba(0,0,0,.55);
    --line:#8b4513; --node:#d6a83d;
  }
}
html.dark .sx-timeline-root,
:root[data-theme="dark"] .sx-timeline-root,
body.dark .sx-timeline-root{
  --bg:#2b2b2b; --fg:#f5deb3; --muted:#e4d4a5;
  --border:#4b4b4b; --hair:#534b3c;
  --card:#3c3a34; --shadow:0 6px 18px rgba(0,0,0,.55);
  --line:#8b4513; --node:#d6a83d;
}

/* ----- Layout & Title ----- */
.sx-timeline-wrap{max-width:1000px;margin:0 auto;padding:0 1rem}
.sx-tl-head{display:flex;justify-content:center;margin:.25rem 0 1.2rem 0}
.sx-tl-title{
  font-family:'Pirata One', cursive; font-size:2.1rem; color:var(--fg);
  text-shadow:2px 2px 0 rgba(0,0,0,.06), 0 0 18px rgba(139,69,19,.25);
  letter-spacing:.02em
}

/* ----- River-like main stem (wavy + vignette top/bottom) ----- */
.sx-tl{position:relative;list-style:none;margin:0;padding:0}
.sx-tl::before{
  /* soft vertical gradient with fade on top & bottom */
  content:""; position:absolute; left:50%; top:0; transform:translateX(-50%);
  width:10px; height:100%;
  background:linear-gradient(to bottom, transparent 0%, var(--line) 10%, var(--line) 90%, transparent 100%);
  border-radius:10px; filter:blur(.2px) saturate(.9) opacity(.9);
  z-index:0;
}
.sx-tl::after{
  /* subtle wavy overlay (SVG data URI), also faded at ends via mask */
  content:""; position:absolute; left:50%; top:0; transform:translateX(-50%);
  width:8px; height:100%;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='1200' viewBox='0 0 8 1200'%3E%3Cpath d='M4,0 C2,60 6,120 4,180 C2,240 6,300 4,360 C2,420 6,480 4,540 C2,600 6,660 4,720 C2,780 6,840 4,900 C2,960 6,1020 4,1080 C2,1140 6,1200 4,1260' stroke='%238b4513' stroke-width='4' fill='none' stroke-linecap='round' stroke-linejoin='round' opacity='0.9'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-size:8px 100%; background-position:center top;
  -webkit-mask-image:linear-gradient(to bottom, transparent 0, black 8%, black 92%, transparent 100%);
          mask-image:linear-gradient(to bottom, transparent 0, black 8%, black 92%, transparent 100%);
  opacity:.9; z-index:0;
}

/* ----- Items & grid ----- */
.sx-tl-item{
  position:relative; padding:2.2rem 0;
  --curve-w: clamp(140px, 22vw, 260px);
  --curve-h: clamp(70px, 12vw, 130px);
  --arrow: 10px;
}
.sx-tl-row{display:grid;grid-template-columns:1fr 24px 1fr;gap:1.1rem;align-items:center;position:relative;z-index:1}

/* Node (coin) on the river */
.sx-tl-node{
  width:22px;height:22px;border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #fff6bf, var(--node));
  box-shadow:0 0 0 6px var(--bg), 0 2px 6px rgba(0,0,0,.25);
  margin:0 auto; z-index:3;
}

/* ----- Curvy connectors with arrowheads (no extra markup) ----- */
/* LEFT card: quarter-ellipse curve from stem to card */
.sx-left.sx-tl-item::before{
  content:""; position:absolute; z-index:1;
  top:calc(50% - var(--curve-h)/2); left:calc(50% - var(--curve-w));
  width:var(--curve-w); height:var(--curve-h);
  border:3px solid transparent; border-top-color:var(--line); border-left-color:var(--line);
  border-radius:var(--curve-w) var(--curve-h); pointer-events:none;
  filter:drop-shadow(0 0 1px rgba(0,0,0,.15));
}
.sx-left.sx-tl-item::after{
  /* arrowhead near card edge */
  content:""; position:absolute; z-index:2;
  top:calc(50% + var(--curve-h)/2 - var(--arrow));
  left:calc(50% - var(--curve-w) - var(--arrow) + 6px);
  width:0;height:0;border:var(--arrow) solid transparent; border-left-color:var(--line);
  transform:rotate(-18deg);
}
/* RIGHT card */
.sx-right.sx-tl-item::before{
  content:""; position:absolute; z-index:1;
  top:calc(50% - var(--curve-h)/2); left:50%;
  width:var(--curve-w); height:var(--curve-h);
  border:3px solid transparent; border-top-color:var(--line); border-right-color:var(--line);
  border-radius:var(--curve-w) var(--curve-h); pointer-events:none;
  filter:drop-shadow(0 0 1px rgba(0,0,0,.15));
}
.sx-right.sx-tl-item::after{
  content:""; position:absolute; z-index:2;
  top:calc(50% + var(--curve-h)/2 - var(--arrow));
  left:calc(50% + var(--curve-w) - 6px);
  width:0;height:0;border:var(--arrow) solid transparent; border-right-color:var(--line);
  transform:rotate(18deg);
}

/* ----- Fancy “treasure-card” look ----- */
.sx-tl-card{
  background:var(--card);
  color:var(--fg);
  border:2px solid var(--border);
  border-left:6px solid var(--accent, var(--other));
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:1.15rem 1.35rem 1.05rem;
  font-family:'Cinzel', serif; font-size:1.05rem;
  background-image:
    radial-gradient(120px 80px at 10% 12%, rgba(139,69,19,.06), transparent 60%),
    radial-gradient(160px 110px at 90% 80%, rgba(0,0,0,.05), transparent 55%);
  position:relative; z-index:2;
}
.sx-left .sx-tl-card{grid-column:1; transform:translateX(-8px) rotate(-1.2deg)}
.sx-right .sx-tl-card{grid-column:3; transform:translateX(8px) rotate(1.1deg)}

.sx-tl-card h4{
  margin:.05rem 0 .35rem 0; line-height:1.25;
  font-family:'Pirata One', cursive; font-size:1.55rem; letter-spacing:.02em
}
.sx-tl-meta{font-size:.92rem;color:var(--muted);display:flex;flex-wrap:wrap;gap:.6rem;margin:.2rem 0}
.sx-tl-desc{margin:.35rem 0 0 0; line-height:1.6; font-style:italic}
.sx-tl-links{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.45rem}
.sx-chip{
  display:inline-flex;align-items:center;gap:.35rem;
  border:1px solid var(--hair); border-radius:999px;
  padding:.22rem .6rem; font-size:.85rem; background:transparent; color:inherit; text-decoration:none
}
.sx-chip .fa{font-size:.9em; color:inherit}

/* ----- Type accents (left border & dot colors) ----- */
.sx-type-edu { --accent: var(--edu) }
.sx-type-work{ --accent: var(--work) }
.sx-type-res { --accent: var(--res)  }
.sx-type-award{--accent: var(--award)}
.sx-type-other{--accent: var(--other)}
.sx-badge{display:inline-flex;align-items:center;gap:.45rem;border:1px solid var(--hair);border-radius:.6rem;padding:.12rem .55rem;font-size:.83rem;background:transparent}
.sx-dot{width:.58rem;height:.58rem;border-radius:999px;background:var(--accent, var(--other))}

/* ----- Responsive (stack) ----- */
@media (max-width: 860px){
  .sx-tl::before, .sx-tl::after{left:12px; transform:none}
  .sx-tl-row{grid-template-columns:24px 1fr; gap:.9rem}
  .sx-left .sx-tl-card, .sx-right .sx-tl-card{grid-column:2; transform:none}
  .sx-left .sx-tl-node, .sx-right .sx-tl-node{grid-column:1;margin-left:0}
  .sx-left .sx-spacer, .sx-right .sx-spacer{display:none}

  /* tighten curves on mobile */
  .sx-tl-item{ --curve-w: clamp(95px, 42vw, 160px); --curve-h: clamp(60px, 18vw, 110px); }
  .sx-left.sx-tl-item::before{ left:0; transform:translateX(12px) }
  .sx-right.sx-tl-item::before{ left:12px }
}
  
/* ----- Optional collapse wrapper styling ----- */
.sx-collapsible summary{list-style:none; cursor:pointer}
.sx-collapsible summary::-webkit-details-marker{display:none}
.sx-collapsible .sx-tl-title{display:inline-flex;align-items:center; gap:.5rem}
.sx-caret{transition:transform .18s ease; display:inline-block}
.sx-collapsible[open] .sx-caret{transform:rotate(90deg)}
</style>


<!-- fallback sample data (used if no src set) -->
<script type="application/json" id="sx-timeline-sample">
[
  {"title":"PhD in Physics at RESCEU","place":"The University of Tokyo","period":"2023 ~","type":"res","desc":"PhD in Physics at RESCEU","url":"https://www.resceu.s.u-tokyo.ac.jp/top.php"},
  {"title":"MSc in Physics at ICRR","place":"The University of Tokyo","period":"2021 – 2023","type":"res","desc":"MSc in Physics at ICRR"},
  {"title":"Project Associate in the Helioseismology lab","place":"TIFR, Mumbai","period":"2020/11 – 2021/04","type":"work","desc":"Project Associate in the Helioseismology lab"},
  {"title":"BTech in Mechanical Engineering, Design and Manufacturing","place":"IIITDM Kancheepuram, Chennai","period":"2016 – 2020","type":"edu","desc":"BTech in Mechanical Engineering, Design and Manufacturing"},
  {"title":"High School Graduation, majoring in Science","place":"Montfort School, Mandla","period":"2002 – 2016","type":"edu","desc":"High School Graduation, majoring in Science"}
]
</script>

<script>
(function(){
  // --- Robust root detection: find the nearest preceding .sx-timeline-root ---
  function findRoot(){
    let el = document.currentScript;
    while(el && (el = el.previousElementSibling)){
      if(el.classList && el.classList.contains('sx-timeline-root')) return el;
    }
    // fallback: global last match
    const all = document.querySelectorAll('.sx-timeline-root');
    return all.length ? all[all.length-1] : null;
  }
  const root = findRoot();
  if(!root){ console.warn('[timeline] root not found'); return; }

  const cfg = {
    src: root.getAttribute('data-src') || "",
    title: root.getAttribute('data-title') || "Timeline",
    collapse: (root.getAttribute('data-collapse')||"false").toLowerCase()==="true",
    open: (root.getAttribute('data-open')||"true").toLowerCase()==="true"
  };

  function wrap(inner){
    if(!cfg.collapse){
      return `<div class="sx-timeline-wrap">
        <div class="sx-tl-head"><h3 class="sx-tl-title">${cfg.title}</h3></div>
        ${inner}
      </div>`;
    }
    const openAttr = cfg.open ? " open" : "";
    return `<div class="sx-timeline-wrap sx-collapsible">
      <details${openAttr}>
        <summary><h3 class="sx-tl-title"><span class="sx-caret">▶</span>${cfg.title}</h3></summary>
        ${inner}
      </details>
    </div>`;
  }

  function sideClass(i){ return (i % 2 === 0) ? "sx-left" : "sx-right"; }
  function typeClass(t){
    const k = (t||"").toLowerCase();
    if(k.startsWith("edu")) return "sx-type-edu";
    if(k.startsWith("wor")) return "sx-type-work";
    if(k.startsWith("res")) return "sx-type-res";
    if(k.startsWith("awa")) return "sx-type-award";
    return "sx-type-other";
  }
  function esc(s){ return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function render(items){
    const list = items.map((it, i) => {
      const cls = `${sideClass(i)} ${typeClass(it.type)}`;
      const title = esc(it.title);
      const place = esc(it.place);
      const period = esc(it.period);
      const desc = it.desc ? esc(it.desc) : "";
      const url = (it.url||"").trim();
      const titleHtml = url ? `<a href="${url.replace(/"/g,'%22')}" target="_blank" rel="noopener" style="text-decoration:none;color:inherit">${title}</a>` : title;

      return `<li class="sx-tl-item ${cls}">
        <div class="sx-tl-row">
          <div class="sx-spacer"></div>
          <div class="sx-tl-node"></div>
          <div class="sx-spacer"></div>

          <div class="sx-tl-card">
            <h4>${titleHtml}</h4>
            <div class="sx-tl-meta">
              <span class="sx-badge"><i class="fa fa-map-marker"></i>${place}</span>
              <span class="sx-badge"><i class="fa fa-calendar"></i>${period}</span>
            </div>
            ${desc ? `<div class="sx-tl-desc">${desc}</div>` : ``}
          </div>
        </div>
      </li>`;
    }).join("");

    const html = wrap(`<ol class="sx-tl">${list}</ol>`);
    root.innerHTML = html;
  }

  async function boot(){
    if(cfg.src){
      try{
        const res = await fetch(new URL(cfg.src, document.baseURI), {cache:'no-cache'});
        if(!res.ok) throw new Error(res.status);
        const data = await res.json();
        render(data);
        return;
      }catch(e){
        console.warn('[timeline] failed to fetch src, falling back to sample', e);
      }
    }
    try{
      const sample = document.getElementById('sx-timeline-sample');
      render(JSON.parse(sample.textContent));
    }catch(e){
      root.innerHTML = wrap(`<p style="color:var(--muted)">No timeline data.</p>`);
    }
  }

  // Run after DOM is ready so sibling search is reliable.
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  }else{
    boot();
  }
})();
</script>

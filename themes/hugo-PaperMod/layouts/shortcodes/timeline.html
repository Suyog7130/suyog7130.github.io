<!-- layouts/shortcodes/timeline.html -->
{{- $src := .Get "src" -}}
{{- $title := .Get "title" | default "Timeline" -}}
{{- $collapse := .Get "collapse" | default "false" -}}
{{- $open := .Get "open" | default "true" -}}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<section class="sx-timeline-root"
  data-src="{{ $src }}"
  data-title="{{ $title }}"
  data-collapse="{{ $collapse }}"
  data-open="{{ $open }}">
</section>

<style>
/* === Treasure-map / sketch timeline (monotone) ===========================
   Fonts: set your own favorites here (from your fonts page).
===========================================================================*/
@import url('https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Spectral:ital,wght@0,400;0,600;1,400&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Mistral&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Parisienne&display=swap');

.sx-timeline-root{
  /* Font variables — swap these to your favorites */
  --font-title: 'Parisienne', serif;
  --font-body:  'Lato', 'Mistral', serif;

  /* Sketch palette (light) */
  --bg:#fdf6e3; --fg:#2d2a26; --muted:#6b5b4a;
  --ink:#4b3a2a; --sepia:#8b7355; --card:#fff7e3;
  --border:#d7c7a1; --hair:#d7c7a1; --shadow:0 8px 16px rgba(0,0,0,.14);
}
@media (prefers-color-scheme: dark){
  .sx-timeline-root{
    --bg:#2b2926; --fg:#f2e6cf; --muted:#d3c7b2; --ink:#a78b6d;
    --sepia:#b89a75; --card:#3b362f; --border:#5a4e43; --hair:#5a4e43;
    --shadow:0 10px 22px rgba(0,0,0,.55);
  }
}
html.dark .sx-timeline-root,
:root[data-theme="dark"] .sx-timeline-root,
body.dark .sx-timeline-root{
  --bg:#2b2926; --fg:#f2e6cf; --muted:#d3c7b2; --ink:#a78b6d;
  --sepia:#b89a75; --card:#3b362f; --border:#5a4e43; --hair:#5a4e43;
  --shadow:0 10px 22px rgba(0,0,0,.55);
}

/* --- Basic layout ------------------------------------------------------ */
.sx-timeline-wrap{max-width:1000px;margin:0 auto;padding:0 1rem}
.sx-tl-head{display:flex;justify-content:center;margin:.25rem 0 1.2rem 0}
.sx-tl-title{
  font-family:var(--font-title);
  font-size:2.1rem;
  color:var(--fg);
  text-shadow:1px 1px 0 rgba(0,0,0,.05), 0 0 14px rgba(75,58,42,.18);
  letter-spacing:.01em
}
.sx-tl{position:relative;list-style:none;margin:0;padding:0}

/* --- SVG canvas for river & connectors -------------------------------- */
.sx-svg{
  position:absolute; inset:0; pointer-events:none; z-index:0;
  filter:url(#sx-rough); /* sketchy wobble */
}
.sx-svg path{ vector-effect:non-scaling-stroke }

/* --- Items ------------------------------------------------------------- */
.sx-tl-item{position:relative;padding:2.2rem 0}
.sx-tl-row{
  display:grid; grid-template-columns:1fr 24px 1fr; gap:1.1rem; align-items:center;
  position:relative; z-index:1;
}

/* Node (“stamp”) — nudged to sit on the river */
.sx-tl-node{
  width:22px; height:22px; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #fff3c5, #d3b06d 70%, #a88443);
  box-shadow:0 0 0 6px var(--bg), 0 2px 6px rgba(0,0,0,.25);
  margin:0 auto; z-index:2; transform:translateX(0)
}

/* Year badge (marker shown above each card) */
.sx-year-badge{
  position:absolute; top:-0.9rem; left:50%; transform:translate(-50%,-50%) rotate(-2deg);
  background:var(--bg); color:var(--fg);
  border:1px solid var(--hair); border-radius:999px;
  padding:.15rem .6rem; font-family:var(--font-title); font-size:.95rem; font-weight: 600;
  box-shadow:0 2px 6px rgba(0,0,0,.08); z-index:3; white-space:nowrap;
}
.sx-right .sx-year-badge{ transform:translate(-50%,-50%) rotate(2deg); }

/* Cards (parchment) */
.sx-tl-card{
  background:var(--card); color:var(--fg);
  border:2px solid var(--border);
  border-left:6px solid var(--sepia);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:1.1rem 1.3rem 1rem;
  font-family:var(--font-body); font-size:1.05rem;
  position:relative; z-index:2;
  background-image:
    radial-gradient(140px 90px at 10% 15%, rgba(139,69,19,.07), transparent 60%),
    radial-gradient(180px 120px at 90% 80%, rgba(0,0,0,.06), transparent 55%);
}
.sx-left .sx-tl-card{grid-column:1; transform:translateX(-8px) rotate(-1.2deg)}
.sx-right .sx-tl-card{grid-column:3; transform:translateX(8px) rotate(1.1deg)}

.sx-tl-card h4{
  margin:.05rem 0 .35rem 0; line-height:1.25;
  font-family:var(--font-title); font-size:1.55rem; letter-spacing:.02em
}
.sx-tl-meta{font-size:.92rem;color:var(--muted);display:flex;flex-wrap:wrap;gap:.6rem;margin:.2rem 0}
.sx-tl-desc{margin:.35rem 0 0 0; line-height:1.6; font-style:italic}
.sx-tl-links{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.45rem}
.sx-chip{
  display:inline-flex;align-items:center;gap:.35rem;
  border:1px solid var(--hair); border-radius:999px;
  padding:.22rem .6rem; font-size:.85rem; background:transparent; color:inherit; text-decoration:none
}
.sx-chip .fa{font-size:.9em; color:inherit}

/* Badges */
.sx-badge{display:inline-flex;align-items:center;gap:.45rem;border:1px solid var(--hair);border-radius:.6rem;padding:.12rem .55rem;font-size:.83rem;background:transparent}
.sx-dot{width:.58rem;height:.58rem;border-radius:999px;background:var(--sepia)}

/* Responsive (stack) */
@media (max-width: 860px){
  .sx-tl-row{grid-template-columns:24px 1fr; gap:.9rem}
  .sx-left .sx-tl-card, .sx-right .sx-tl-card{grid-column:2; transform:none}
  .sx-left .sx-tl-node, .sx-right .sx-tl-node{grid-column:1; margin-left:0}
}

/* Optional collapse wrapper */
.sx-collapsible summary{list-style:none; cursor:pointer}
.sx-collapsible summary::-webkit-details-marker{display:none}
.sx-collapsible .sx-tl-title{display:inline-flex;align-items:center; gap:.5rem}
.sx-caret{transition:transform .18s ease; display:inline-block}
.sx-collapsible[open] .sx-caret{transform:rotate(90deg)}
</style>

<!-- Fallback sample data -->
<script type="application/json" id="sx-timeline-sample">
[
  {"title":"PhD in Physics","place":"The University of Tokyo","period":"2023 ~","year":2023,"type":"res","desc":"PhD in Physics at RESCEU","url":"https://www.resceu.s.u-tokyo.ac.jp/top.php"},
  {"title":"MSc in Physics","place":"The University of Tokyo","period":"2021 ~ 2023","year":2021,"type":"res","desc":"MSc in Physics at ICRR"},
  {"title":"Project Associate in the Helioseismology lab","place":"TIFR, Mumbai","period":"2020/11 ~ 2021/04","year":2020,"type":"work","desc":"Project Associate in the Helioseismology lab"},
  {"title":"BTech in Mechanical Engineering, Design and Manufacturing","place":"IIITDM Kancheepuram, Chennai","period":"2016 ~ 2020","year":2016,"type":"edu","desc":"BTech in Mechanical Engineering, Design and Manufacturing"},
  {"title":"High School Graduation, majoring in Science","place":"Montfort School, Mandla","period":"2002 ~ 2016","year":2002,"type":"edu","desc":"High School Graduation, majoring in Science"}
]
</script>

<script>
(function(){
  function findRoot(){
    let el = document.currentScript;
    while(el && (el = el.previousElementSibling)){
      if(el.classList && el.classList.contains('sx-timeline-root')) return el;
    }
    const all = document.querySelectorAll('.sx-timeline-root');
    return all.length ? all[all.length-1] : null;
  }
  const root = findRoot(); if(!root) return;

  const cfg = {
    src: root.getAttribute('data-src') || "",
    title: root.getAttribute('data-title') || "Timeline",
    collapse: (root.getAttribute('data-collapse')||"false").toLowerCase()==="true",
    open: (root.getAttribute('data-open')||"true").toLowerCase()==="true"
  };

  function wrap(inner){
    if(!cfg.collapse){
      return `<div class="sx-timeline-wrap">
        <div class="sx-tl-head"><h3 class="sx-tl-title">${cfg.title}</h3></div>
        <div class="sx-tl-stage" style="position:relative">${inner}</div>
      </div>`;
    }
    const openAttr = cfg.open ? " open" : "";
    return `<div class="sx-timeline-wrap sx-collapsible">
      <details${openAttr}>
        <summary><h3 class="sx-tl-title"><span class="sx-caret">▶</span>${cfg.title}</h3></summary>
        <div class="sx-tl-stage" style="position:relative">${inner}</div>
      </details>
    </div>`;
  }

  function esc(s){ return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function sideClass(i){ return (i % 2 === 0) ? "sx-left" : "sx-right"; }
  function extractYear(it){
    if(it.year) return String(it.year);
    const m = (it.period||'').match(/\b(20\d{2}|19\d{2})\b/g);
    return m && m.length ? m[1] : "";
  }

  function render(items){
    const list = items.map((it, i) => {
      const year = extractYear(it);
      const title = esc(it.title), place = esc(it.place), period = esc(it.period);
      const desc = it.desc ? esc(it.desc) : ""; const url = (it.url||"").trim();
      const titleHtml = url ? `<a href="${url.replace(/"/g,'%22')}" target="_blank" rel="noopener" style="text-decoration:none;color:inherit">${title}</a>` : title;
      return `<li class="sx-tl-item ${sideClass(i)}" data-i="${i}">
        <div class="sx-tl-row">
          <div class="sx-spacer"></div>
          <div class="sx-tl-node"></div>
          <div class="sx-spacer"></div>
          <div class="sx-tl-card">
            ${year ? `<div class="sx-year-badge" aria-label="Year">${year}</div>` : ``}
            <div class="sx-tl-meta">
              <span class="sx-badge"><i class="fa fa-map-marker"></i>${place}</span>
              <span class="sx-badge"><i class="fa fa-calendar"></i>${period}</span>
            </div>
            <h4>${titleHtml}</h4>
            ${desc ? `<div class="sx-tl-desc">${desc}</div>` : ``}
          </div>
        </div>
      </li>`;
    }).join("");

    // SVG canvas for river & connectors (under the list)
    const svg = `
      <svg class="sx-svg" preserveAspectRatio="none">
        <defs>
          <!-- Arrowhead -->
          <marker id="sx-arrow" viewBox="0 0 12 12" refX="10" refY="6"
                  markerWidth="10" markerHeight="10" orient="auto-start-reverse">
            <path d="M0,0 L12,6 L0,12 L3.5,6 Z" fill="var(--ink)"></path>
          </marker>
          <!-- Sketchy roughness -->
          <filter id="sx-rough">
            <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" seed="7" stitchTiles="stitch" result="turb"/>
            <feColorMatrix type="saturate" values="0.12" in="turb" result="noise"/>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="0.6" xChannelSelector="R" yChannelSelector="G"/>
          </filter>
          <!-- River gradient (fade top/bottom) -->
          <linearGradient id="sx-river-grad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%"  stop-color="var(--ink)" stop-opacity="0"/>
            <stop offset="8%"  stop-color="var(--ink)" stop-opacity=".9"/>
            <stop offset="92%" stop-color="var(--ink)" stop-opacity=".9"/>
            <stop offset="100%" stop-color="var(--ink)" stop-opacity="0"/>
          </linearGradient>
        </defs>
        <g class="sx-river"></g>
        <g class="sx-connectors"></g>
      </svg>`;

    root.innerHTML = wrap(`<ol class="sx-tl">${list}</ol>` + svg);

    // After DOM paint, layout connectors
    requestAnimationFrame(layoutSVG);
    let t=null; addEventListener('resize', ()=>{ clearTimeout(t); t = setTimeout(layoutSVG, 120); });
    setTimeout(layoutSVG, 500);
  }

  function layoutSVG(){
    const stage = root.querySelector('.sx-tl-stage');
    const list = root.querySelector('.sx-tl');
    const svg  = root.querySelector('.sx-svg');
    if(!stage || !list || !svg) return;

    // Size the SVG to stage box
    const r = stage.getBoundingClientRect();
    svg.setAttribute('viewBox', `0 0 ${r.width} ${r.height}`);
    svg.setAttribute('width', r.width);
    svg.setAttribute('height', r.height);

    const riverG = svg.querySelector('.sx-river');
    const connG  = svg.querySelector('.sx-connectors');
    riverG.innerHTML = ''; connG.innerHTML = '';

    // Meandering river: centerX + A*sin(k*y)
    const A = Math.max(8, Math.min(22, r.width * 0.018));
    const k = 2 * Math.PI / Math.max(280, Math.min(520, r.height*0.6));
    const cx = r.width / 2;
    const steps = Math.max(40, Math.floor(r.height / 18));
    let d = '';
    for(let i=0;i<=steps;i++){
      const y = (i/steps)*r.height;
      const x = cx + A * Math.sin(k * (y + 40));
      d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
    }
    const river = document.createElementNS('http://www.w3.org/2000/svg','path');
    river.setAttribute('d', d);
    river.setAttribute('fill','none');
    river.setAttribute('stroke','url(#sx-river-grad)');
    river.setAttribute('stroke-width','8');
    river.setAttribute('stroke-linecap','round');
    riverG.appendChild(river);

    function riverX(y){ return cx + A * Math.sin(k * (y + 40)); }

    // For each item: arrow from river to nearest card corner; nudge node onto river
    const items = Array.from(root.querySelectorAll('.sx-tl-item'));
    items.forEach(li=>{
      const row = li.querySelector('.sx-tl-row');
      const card = li.querySelector('.sx-tl-card');
      const node = li.querySelector('.sx-tl-node');
      if(!row || !card || !node) return;

      const rowRect  = row.getBoundingClientRect();
      const cardRect = card.getBoundingClientRect();
      const nodeRect = node.getBoundingClientRect();

      const yMid = (rowRect.top + rowRect.bottom)/2 - r.top;
      const xStart = riverX(yMid);

      // Node: move horizontally to sit on river
      const nodeCenter = (nodeRect.left + nodeRect.right)/2 - r.left;
      node.style.transform = `translateX(${(xStart - nodeCenter).toFixed(1)}px)`;

      // Nearest card corner
      const corners = [
        {x:cardRect.left  - r.left, y:cardRect.top    - r.top},   // TL
        {x:cardRect.right - r.left, y:cardRect.top    - r.top},   // TR
        {x:cardRect.left  - r.left, y:cardRect.bottom - r.top},   // BL
        {x:cardRect.right - r.left, y:cardRect.bottom - r.top}    // BR
      ];
      let best = corners[0], bestd = Infinity;
      for(const c of corners){
        const dx = c.x - xStart, dy = c.y - yMid;
        const dist = dx*dx + dy*dy;
        if(dist < bestd){ bestd = dist; best = c; }
      }
      // Pull the end slightly inward so the arrowhead rests on the parchment edge
      const pull = 12;
      const end = {
        x: best.x + (best.x > xStart ? -pull : pull),
        y: best.y + (best.y > yMid   ? -pull : pull)
      };

      // Gentle quadratic curve
      const ctrl = {
        x: (xStart + end.x)/2 + (end.x > xStart ? 12 : -12),
        y: (yMid + end.y)/2 + (end.y > yMid ? -8 : 8)
      };

      const p = document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d', `M ${xStart.toFixed(1)} ${yMid.toFixed(1)} Q ${ctrl.x.toFixed(1)} ${ctrl.y.toFixed(1)} ${end.x.toFixed(1)} ${end.y.toFixed(1)}`);
      p.setAttribute('fill','none');
      p.setAttribute('stroke','var(--ink)');
      p.setAttribute('stroke-width','2.5');
      p.setAttribute('marker-end','url(#sx-arrow)');
      p.setAttribute('stroke-linecap','round');
      connG.appendChild(p);
    });
  }

  async function boot(){
    let items=[];
    if(cfg.src){
      try{
        const res = await fetch(new URL(cfg.src, document.baseURI), {cache:'no-cache'});
        if(!res.ok) throw new Error(res.status);
        items = await res.json();
      }catch(e){
        console.warn('[timeline] failed to fetch src, using sample', e);
      }
    }
    if(!items.length){
      try{ items = JSON.parse(document.getElementById('sx-timeline-sample').textContent); }
      catch(e){ items=[]; }
    }
    if(!items.length){
      root.innerHTML = `<div class="sx-timeline-wrap"><div class="sx-tl-head"><h3 class="sx-tl-title">${cfg.title}</h3></div><p style="color:var(--muted)">No timeline data.</p></div>`;
      return;
    }
    render(items);
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>

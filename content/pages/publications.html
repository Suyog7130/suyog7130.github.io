---
title: "Publications"
author_profile: true
hideTags: true
showTOC: false
---

<!-- ===== Dependencies (icons + Dimensions badge) ===== -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.4/css/academicons.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script async src="https://badge.dimensions.ai/badge.js" charset="utf-8"></script>

<!-- =========================
     INTERACTIVE QUICK VIEW
     ========================= -->
<section class="pubs-root">
  <!-- <h2 style="margin:0 0 .6rem 0">Publications — Quick View (interactive)</h2> -->

  <div class="pub-controls" role="region" aria-label="Publications controls">
    <button id="btnFilter" class="pub-btn"><i class="fa fa-filter" aria-hidden="true"></i> Filter</button>
    <button id="btnSort" class="pub-btn"><i class="fa fa-sort" aria-hidden="true"></i> Sort</button>
    <span id="countLabel" class="pub-count" aria-live="polite"></span>
  </div>

  <div id="activeFilters" class="active-filters" aria-live="polite"></div>

  <!-- Reverse-numbered list renders here -->
  <ol id="pubList" class="pub-list" reversed></ol>

  <!-- Filter dialog -->
  <dialog id="filterDialog" aria-label="Filter publications">
    <form method="dialog" class="dialog-form">
      <h3>Filter</h3>

      <fieldset class="filter-group">
        <legend>Type</legend>
        <div id="filterTypes" class="filter-chips"><!-- populated by JS --></div>
      </fieldset>

      <fieldset class="filter-group">
        <legend>Subset / Topic</legend>
        <div id="filterSubsets" class="filter-chips"><!-- populated by JS --></div>
      </fieldset>

      <fieldset class="filter-group">
        <legend>Year</legend>
        <div class="year-row">
          <label>From&nbsp;<input id="yearFrom" type="number" step="1" min="1900" style="width:7rem"></label>
          <label>To&nbsp;<input id="yearTo" type="number" step="1" min="1900" style="width:7rem"></label>
          <button id="btnResetYear" type="button" class="pub-btn pub-btn-secondary" style="margin-left:auto">Reset year</button>
        </div>
      </fieldset>

      <div class="dialog-actions">
        <button value="cancel" class="pub-btn pub-btn-secondary">Close</button>
        <button id="btnResetFilters" type="button" class="pub-btn pub-btn-secondary">Reset all</button>
        <button id="btnApplyFilters" type="submit" class="pub-btn pub-btn-primary">Apply</button>
      </div>
    </form>
  </dialog>

  <!-- Sort dialog -->
  <dialog id="sortDialog" aria-label="Sort publications">
    <form method="dialog" class="dialog-form">
      <h3>Sort</h3>
      <fieldset class="filter-group">
        <legend>Order</legend>
        <label class="radio"><input type="radio" name="sortMode" value="year-desc" checked> Year — newest → oldest</label>
        <label class="radio"><input type="radio" name="sortMode" value="year-asc"> Year — oldest → newest</label>
        <label class="radio"><input type="radio" name="sortMode" value="title-asc"> Title — A → Z</label>
        <label class="radio"><input type="radio" name="sortMode" value="title-desc"> Title — Z → A</label>
        <label class="radio"><input type="radio" name="sortMode" value="first-asc"> First author — A → Z</label>
        <label class="radio"><input type="radio" name="sortMode" value="first-desc"> First author — Z → A</label>
        <label class="radio"><input type="radio" name="sortMode" value="len-desc"> Paper length — longest → shortest</label>
        <label class="radio"><input type="radio" name="sortMode" value="len-asc"> Paper length — shortest → longest</label>
        <label class="radio"><input type="radio" name="sortMode" value="cites-desc"> Citations — most → fewest*</label>
        <label class="radio"><input type="radio" name="sortMode" value="cites-asc"> Citations — fewest → most*</label>
      </fieldset>
      <p class="hint">* Sorting uses a numeric <code>cites</code> field from `.bib` when present; the on-card badge still shows live Dimensions counts from the DOI.</p>
      <div class="dialog-actions">
        <button value="cancel" class="pub-btn pub-btn-secondary">Close</button>
        <button id="btnApplySort" type="submit" class="pub-btn pub-btn-primary">Apply</button>
      </div>
    </form>
  </dialog>

  <!-- Hover preview tooltip (used by Abstract button only) -->
  <div id="previewTip" class="preview-tip" role="tooltip" aria-hidden="true"></div>
</section>

<!-- =========================
     STYLES (scoped, minimal)
     ========================= -->
<style>
  .pub-controls{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin:0 0 1rem 0}
  .pub-btn{border:1px solid var(--mm-btn-border,#d0d7de);padding:.4rem .7rem;border-radius:.5rem;background:#fff;cursor:pointer;font:inherit}
  .pub-btn:hover{background:#f6f8fa}
  .pub-btn-primary{background:#1f6feb;color:#fff;border-color:#1f6feb}
  .pub-btn-primary:hover{filter:brightness(0.95)}
  .pub-btn-secondary{background:#fff;color:#24292f}
  .hint{font-size:.85rem;color:#667}

  .pub-count{margin-left:auto;font-size:.95rem;color:#555}
  .active-filters{display:flex;flex-wrap:wrap;gap:.5rem;margin:.25rem 0 1rem 0}
  .chip{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #d0d7de;border-radius:999px;padding:.2rem .55rem;font-size:.85rem;background:#fff}
  .chip button{all:unset;cursor:pointer;display:inline-flex}
  .chip .fa{font-size:.8em;color:#555}

  .pub-list{counter-reset: none; padding-left: 1.2rem}
  .pub-item{margin:0 0 .9rem 0;padding:0 0 .9rem 0;border-bottom:1px dashed #e5e7eb}
  .pub-title{font-weight:600;line-height:1.35;margin:0}
  .pub-title a{text-decoration:none}
  .pub-title a:hover{text-decoration:underline}
  .pub-meta{color:#444;margin:.15rem 0 .45rem 0;font-size:.95rem}
  .subsets{display:flex;flex-wrap:wrap;gap:.35rem}
  .subset{font-size:.78rem;border:1px solid #e5e7eb;border-radius:.4rem;padding:.05rem .4rem;background:#fafbfc}
  .actions{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.35rem}
  .btn-chip{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #d0d7de;border-radius:.5rem;padding:.25rem .45rem;font-size:.85rem;background:#fff;text-decoration:none;line-height:1}
  .btn-chip:hover{background:#f6f8fa}
  .btn-chip .fa, .btn-chip .ai{font-size:.9em}
  .btn-badge{padding:.2rem .35rem}
  .btn-badge .__dimensions_Badge_Font{font-size:.82em!important}

  dialog{border:none;border-radius:12px;padding:1rem 1rem 1.2rem 1rem;max-width:720px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  .dialog-form h3{margin:.3rem 0 .7rem 0}
  .filter-group{margin:.6rem 0}
  .filter-chips{display:flex;flex-wrap:wrap;gap:.45rem}
  .chip-toggle{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #d0d7de;border-radius:999px;padding:.25rem .6rem;background:#fff;cursor:pointer}
  .chip-toggle input{accent-color:#1f6feb}
  .radio{display:flex;gap:.5rem;align-items:center;margin:.25rem 0}
  .dialog-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.8rem}
  .year-row{display:flex;gap:.6rem;align-items:center}

  .preview-tip{position:fixed;max-width:520px;background:#111;color:#fff;padding:.6rem .75rem;border-radius:.5rem;font-size:.92rem;line-height:1.35;box-shadow:0 6px 18px rgba(0,0,0,.25);z-index:99;pointer-events:none;opacity:0;transform:translateY(4px);transition:opacity .12s ease,transform .12s ease}
  .preview-tip[data-show="true"]{opacity:1;transform:translateY(0)}

  @media (prefers-color-scheme: dark){
    .pub-btn,.chip,.chip-toggle,.btn-chip{background:#0d1117;border-color:#30363d;color:#c9d1d9}
    .pub-btn:hover,.btn-chip:hover{background:#161b22}
    .pub-item{border-color:#30363d}
    .subset{background:#0d1117;border-color:#30363d}
    dialog{background:#0d1117;color:#c9d1d9}
    .preview-tip{background:#161b22}
  }
</style>

<!-- =========================
     DATA + RENDER LOGIC
     ========================= -->
<script>
/*** ====== SETTINGS ====== ***/
const BIB_PATH = "../../assets/bib/publications.bib";   // <- set your .bib path here
const PROJECT_URL_MAP = {
  // "apj2019-waldmeier": "/research/waldmeier-effect/",
  // "your-citekey-here": "/research/your-project/"
};
const VENUE_SHORT = {
  "The Astrophysical Journal":"ApJ", "Astrophysical Journal":"ApJ",
  "Research Notes of the American Astronomical Society":"RNAAS",
  "Proceedings of Science":"PoS","PoS (ICRC2023)":"PoS",
  "Monthly Notices of the Royal Astronomical Society":"MNRAS",
  "Physical Review Letters":"PRL","Physical Review D":"PRD",
  "arXiv e-prints":"arXiv"
};

/*** ====== STATE ====== ***/
const els = {
  list: document.getElementById('pubList'),
  count: document.getElementById('countLabel'),
  tip: document.getElementById('previewTip'),
  filterDlg: document.getElementById('filterDialog'),
  sortDlg: document.getElementById('sortDialog'),
  filterTypes: document.getElementById('filterTypes'),
  filterSubsets: document.getElementById('filterSubsets'),
  activeFilters: document.getElementById('activeFilters'),
  btnFilter: document.getElementById('btnFilter'),
  btnSort: document.getElementById('btnSort'),
  btnApplyFilters: document.getElementById('btnApplyFilters'),
  btnResetFilters: document.getElementById('btnResetFilters'),
  btnApplySort: document.getElementById('btnApplySort'),
  yearFrom: document.getElementById('yearFrom'),
  yearTo: document.getElementById('yearTo'),
  btnResetYear: document.getElementById('btnResetYear'),
};

const state = {
  all: [],            // all PUBS from .bib
  sortMode: 'year-desc',
  types: new Set(),   // empty = all
  subsets: new Set(), // empty = all
  yearFrom: null,
  yearTo: null,
  minYear: null,
  maxYear: null
};

/*** ====== UTILS ====== ***/
function uniqueSorted(arr){ return [...new Set(arr)].sort((a,b)=>a.localeCompare(b,'en',{sensitivity:'base'})); }
function trimBraces(str){ return (str||'').replace(/^{|}$/g,''); }
function untex(s){
  if(!s) return '';
  return s
    .replace(/\\&/g,'&')
    .replace(/\\%/g,'%')
    .replace(/{\\'a}/g,'á').replace(/\\'a/g,'á')
    .replace(/{\\"o}/g,'ö').replace(/\\"o/g,'ö')
    .replace(/[{}]/g,''); // crude but keeps things clean
}
function authorToShort(a){
  // handle "Last, First Middle" OR "First Middle Last"
  a = a.trim();
  if(a.includes(',')){
    const [last, firsts] = a.split(',',2).map(s=>s.trim());
    return (firsts||'').split(/\s+/).filter(Boolean).map(x=>x[0].toUpperCase()+'.').join(' ') + ' ' + last;
  }else{
    const parts = a.split(/\s+/).filter(Boolean);
    const last = parts.pop();
    const inits = parts.map(x=>x[0].toUpperCase()+'.').join(' ');
    return (inits ? inits+' ' : '') + last;
  }
}
function authorArrayToShort(list){
  if(!list || !list.length) return '';
  if(list.length<=3) return list.map(authorToShort).join(', ');
  return authorToShort(list[0]) + ' et al.';
}
function pagesToLen(p){
  if(!p) return null;
  const m = p.match(/(\d+)\s*[-–—]\s*(\d+)/);
  if(!m) return null;
  const a = parseInt(m[1],10), b = parseInt(m[2],10);
  if(isNaN(a)||isNaN(b)) return null;
  return Math.max(0, b - a + 1);
}
function firstAuthorKey(p){ return (p.authors && p.authors[0] || '').toLowerCase(); }
function venueShort(v){ return VENUE_SHORT[v] || v || ''; }
function scholarLink(title, firstAuthor){
  const q = [title, firstAuthor ? firstAuthor.split(',')[0] : ''].filter(Boolean).join(' ');
  return 'https://scholar.google.com/scholar?q=' + encodeURIComponent(q);
}

/*** ====== BIBTEX PARSER (lightweight, tolerant) ====== ***/
function parseBibTeX(input){
  const text = input.replace(/^[ \t]*%.*$/gm,''); // strip % comments
  const entries = [];
  let i = 0;
  while(true){
    const at = text.indexOf('@', i);
    if(at === -1) break;
    // read type
    const braceIdx = text.indexOf('{', at);
    const parenIdx = text.indexOf('(', at);
    let open = braceIdx, closeCh = '}';
    if(parenIdx !== -1 && (braceIdx === -1 || parenIdx < braceIdx)){ open = parenIdx; closeCh = ')'; }
    if(open === -1) break;
    const type = text.slice(at+1, open).trim().toLowerCase();
    // read until matching closing
    let depth = 0, j = open, end = -1;
    for(; j < text.length; j++){
      const ch = text[j];
      if(ch === '{' || ch==='(') depth++;
      else if(ch === '}' || ch===')'){ depth--; if(depth===0){ end = j; break; } }
    }
    if(end === -1) break;
    const body = text.slice(open+1, end).trim();
    // citekey up to first comma at depth 0
    let k=0, keyEnd=-1, d=0;
    for(; k<body.length; k++){
      const ch = body[k];
      if(ch === '{') d++;
      if(ch === '}') d--;
      if(ch === ',' && d===0){ keyEnd = k; break; }
    }
    if(keyEnd === -1){ i = end+1; continue; }
    const citekey = body.slice(0,keyEnd).trim();
    const fieldsText = body.slice(keyEnd+1).trim();
    const fields = {};
    // parse fields name = value, respecting braces/quotes
    let p=0;
    while(p < fieldsText.length){
      // skip commas/whitespace
      while(p<fieldsText.length && /[\s,]/.test(fieldsText[p])) p++;
      if(p>=fieldsText.length) break;
      // read name
      const nameStart = p;
      while(p<fieldsText.length && /[A-Za-z_]/.test(fieldsText[p])) p++;
      const name = fieldsText.slice(nameStart,p).toLowerCase();
      while(p<fieldsText.length && /\s/.test(fieldsText[p])) p++;
      if(fieldsText[p] !== '='){ // malformed
        while(p<fieldsText.length && fieldsText[p]!==',') p++;
        continue;
      }
      p++; // skip '='
      while(p<fieldsText.length && /\s/.test(fieldsText[p])) p++;
      // read value
      let val = '';
      if(fieldsText[p] === '{'){
        let depth2=0;
        p++;
        const start=p;
        for(; p<fieldsText.length; p++){
          const ch=fieldsText[p];
          if(ch==='{') depth2++;
          else if(ch==='}'){
            if(depth2===0){ val = fieldsText.slice(start,p); p++; break; }
            depth2--;
          }
        }
      }else if(fieldsText[p] === '"'){
        p++;
        const start=p;
        for(; p<fieldsText.length; p++){
          if(fieldsText[p]==='"' && fieldsText[p-1] !== '\\'){ val = fieldsText.slice(start,p); p++; break; }
        }
      }else{
        const start=p;
        while(p<fieldsText.length && /[^,\s]/.test(fieldsText[p])) p++;
        val = fieldsText.slice(start,p);
      }
      fields[name] = val.trim();
      // continue to next
    }
    entries.push({type, key: citekey, fields});
    i = end+1;
  }
  return entries;
}

/*** ====== MAP BIB ENTRY -> PUB ITEM ====== ***/
function bibToPub(e){
  const f = e.fields;
  const typeMap = {
    article:'Journal', inproceedings:'Conference', incollection:'Conference',
    phdthesis:'Thesis', mastersthesis:'Thesis', thesis:'Thesis',
    techreport:'Report', book:'Book', misc: (f.eprint||f.archiveprefix)?'Preprint':'Other',
    unpublished:'Preprint'
  };
  const typ = typeMap[e.type] || 'Other';

  const authors = (f.author||'').split(/\s+and\s+/i).map(untex).filter(Boolean);
  const year = parseInt((f.year||'').match(/\d{4}/)?.[0]||'');
  const month = (f.month||'').toString().padStart(2,'0');
  const date = (year? String(year):'') + (month? '-' + month : '');

  const title = untex(trimBraces(f.title||'')).replace(/\s+/g,' ').trim();
  const venue = untex(f.journal || f.booktitle || f.school || f.publisher || '');
  const vShort = venueShort(venue);

  const doi = (f.doi||'').replace(/^https?:\/\/(dx\.)?doi\.org\//,'').trim() || '';
  const url = (f.url||'').trim();
  const eprint = (f.eprint||'').trim();
  const arxiv = /^arxiv$/i.test(f.archiveprefix||'') || /^arXiv:/i.test(eprint) ? (eprint.replace(/^arXiv:/i,'')) : '';
  const preprintUrl = arxiv ? ('https://arxiv.org/abs/' + arxiv) : ( /^https?:\/\/arxiv\.org\/abs\//.test(url) ? url : '' );
  const paperUrl = doi ? ('https://doi.org/' + doi) : ( url && !preprintUrl ? url : '' );

  const pages = f.pages ? untex(f.pages) : '';
  const length = pagesToLen(pages);
  const cites = parseInt((f.cites||'').toString(),10);
  const abstract = untex(f.abstract || '');

  const keywords = (f.keywords||f.keyword||'').split(/[,;]/).map(s=>s.trim()).filter(Boolean);
  const subsets = keywords.length ? keywords : (venue ? [vShort] : []);

  // External extras (custom fields you may add in .bib)
  const codeUrl = f.code || f.github || '';
  const dataUrl = f.data || f.dataset || '';

  return {
    id: e.key,
    year, date, type: typ,
    title, shortTitle: title, // keep same unless you want to add a custom field later
    authors, venue, venueShort: vShort,
    volume: f.volume||'', issue: f.number||'', pages,
    doi: doi || null, arxiv: arxiv || null,
    paperUrl: paperUrl || null, preprintUrl: preprintUrl || null,
    codeUrl: codeUrl || null, dataUrl: dataUrl || null,
    url: url || null,
    abstract, subsets,
    length: (length||null),
    citations: isNaN(cites)? null : cites
  };
}

/*** ====== RENDERING ====== ***/
function initFilters(pubs){
  const allTypes = uniqueSorted(pubs.map(p=>p.type));
  const allSubsets = uniqueSorted(pubs.flatMap(p=>p.subsets||[]));
  const years = pubs.map(p=>p.year).filter(Boolean);
  state.minYear = Math.min(...years);
  state.maxYear = Math.max(...years);
  state.yearFrom = state.minYear; state.yearTo = state.maxYear;

  // Build type chips
  els.filterTypes.innerHTML = allTypes.map(t => `
    <label class="chip-toggle"><input type="checkbox" value="${t}"> ${t}</label>
  `).join('');

  // Build subset chips
  els.filterSubsets.innerHTML = allSubsets.map(s => `
    <label class="chip-toggle"><input type="checkbox" value="${s}"> ${s}</label>
  `).join('');

  els.yearFrom.min = els.yearTo.min = String(state.minYear);
  els.yearFrom.max = els.yearTo.max = String(state.maxYear);
  els.yearFrom.value = String(state.yearFrom);
  els.yearTo.value = String(state.yearTo);
}

function linkForTitle(p){
  return PROJECT_URL_MAP[p.id] || p.paperUrl || p.preprintUrl || (p.doi ? `https://doi.org/${p.doi}` : (p.url || '#'));
}
function button(label, iconClass, url){
  if(!url) return '';
  const safe = url.replace(/"/g,'%22');
  return `<a class="btn-chip" href="${safe}" target="_blank" rel="noopener">
    <i class="${iconClass}" aria-hidden="true"></i> ${label}
  </a>`;
}
function dimsBadge(doi){
  if(!doi) return '';
  return `<span class="btn-chip btn-badge">
    <span class="__dimensions_badge_embed__" data-doi="${doi}" data-hide-zero-citations="true" data-style="small_rectangle"></span>
  </span>`;
}

function passesFilters(p){
  const tOK = state.types.size ? state.types.has(p.type) : true;
  const sOK = state.subsets.size ? (p.subsets||[]).some(s=>state.subsets.has(s)) : true;
  const yOK = (!state.yearFrom || !p.year || p.year >= state.yearFrom) &&
              (!state.yearTo   || !p.year || p.year <= state.yearTo);
  return tOK && sOK && yOK;
}

function sortPubs(list){
  const m = state.sortMode;
  return [...list].sort((a,b)=>{
    if(m==='year-desc') return (b.year-a.year)||a.title.localeCompare(b.title);
    if(m==='year-asc')  return (a.year-b.year)||a.title.localeCompare(b.title);
    if(m==='title-asc') return a.title.localeCompare(b.title,'en',{sensitivity:'base'});
    if(m==='title-desc')return b.title.localeCompare(a.title,'en',{sensitivity:'base'});
    if(m==='first-asc') return firstAuthorKey(a).localeCompare(firstAuthorKey(b));
    if(m==='first-desc')return firstAuthorKey(b).localeCompare(firstAuthorKey(a));
    if(m==='len-desc')  return (b.length||0)-(a.length||0);
    if(m==='len-asc')   return (a.length||0)-(b.length||0);
    if(m==='cites-desc')return (b.citations||0)-(a.citations||0);
    if(m==='cites-asc') return (a.citations||0)-(b.citations||0);
    return 0;
  });
}

function renderActiveFilters(){
  const chips = [];
  state.types.forEach(t=>{
    chips.push(`<span class="chip">Type: ${t}<button aria-label="Remove ${t}" data-x-type="${t}"><i class="fa fa-times"></i></button></span>`);
  });
  state.subsets.forEach(s=>{
    chips.push(`<span class="chip">Topic: ${s}<button aria-label="Remove ${s}" data-x-subset="${s}"><i class="fa fa-times"></i></button></span>`);
  });
  if(state.yearFrom!==state.minYear || state.yearTo!==state.maxYear){
    chips.push(`<span class="chip">Years: ${state.yearFrom}–${state.yearTo}<button aria-label="Reset years" data-x-year="1"><i class="fa fa-times"></i></button></span>`);
  }
  els.activeFilters.innerHTML = chips.join('');
  els.activeFilters.querySelectorAll('button[data-x-type]').forEach(b=>{
    b.addEventListener('click',()=>{ state.types.delete(b.dataset.xType); syncDialogChecks(); render(); });
  });
  els.activeFilters.querySelectorAll('button[data-x-subset]').forEach(b=>{
    b.addEventListener('click',()=>{ state.subsets.delete(b.dataset.xSubset); syncDialogChecks(); render(); });
  });
  els.activeFilters.querySelectorAll('button[data-x-year]').forEach(b=>{
    b.addEventListener('click',()=>{ state.yearFrom=state.minYear; state.yearTo=state.maxYear; syncDialogChecks(); render(); });
  });
}

function render(){
  const filtered = state.all.filter(p=>passesFilters(p));
  const sorted = sortPubs(filtered);
  els.list.setAttribute('start', String(sorted.length));
  els.list.innerHTML = sorted.map(p=>{
    const titleUrl = linkForTitle(p);
    const meta = `${authorArrayToShort(p.authors)} — ${p.venueShort || p.venue || ''}${p.year ? ' ('+p.year+')' : ''}${p.type ? ' • '+p.type : ''}${p.length? ' • ' + p.length + ' pp.' : ''}`;
    const subsetChips = (p.subsets||[]).map(s=>`<span class="subset">${s}</span>`).join('');
    const actions = [
      button('Paper','fa fa-file-pdf',p.paperUrl),
      button('Preprint','fa fa-edit',p.preprintUrl),
      button('Code','fa fa-code',p.codeUrl),
      button('Data','fa fa-database',p.dataUrl),
      button('DOI','ai ai-doi', p.doi ? `https://doi.org/${p.doi}` : null),
      button('Scholar','ai ai-google-scholar', scholarLink(p.title, p.authors?.[0]||'')),
      p.doi ? dimsBadge(p.doi) : ''
    ].join('');
    const absBtn = p.abstract ? `<a class="btn-chip abstract-btn" href="javascript:void(0)" data-abstract="${p.abstract.replace(/"/g,'&quot;')}"><i class="fa fa-align-left"></i> Abstract</a>` : '';
    return `
      <li class="pub-item">
        <p class="pub-title">
          <a href="${titleUrl}" class="title-link">${p.title}</a>
        </p>
        <div class="pub-meta">${meta}</div>
        <div class="subsets">${subsetChips}</div>
        <div class="actions">${actions} ${absBtn}</div>
      </li>
    `;
  }).join('');

  els.count.textContent = `Showing ${sorted.length} of ${state.all.length}`;
  renderActiveFilters();
  wireAbstractHover();
}

function wireAbstractHover(){
  document.querySelectorAll('.abstract-btn').forEach(btn=>{
    btn.addEventListener('mouseenter', e=>{
      showTip(btn.dataset.abstract || '', e.clientX, e.clientY);
    });
    btn.addEventListener('mousemove', e=>{
      if(els.tip.getAttribute('data-show') === 'true'){
        positionTip(e.clientX, e.clientY);
      }
    });
    ['mouseleave','blur'].forEach(ev=>btn.addEventListener(ev, hideTip));
  });
}

function syncDialogChecks(){
  // Types
  els.filterTypes.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.checked = state.types.has(cb.value);
  });
  // Subsets
  els.filterSubsets.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.checked = state.subsets.has(cb.value);
  });
  // Sort radios
  els.sortDlg.querySelectorAll('input[name=sortMode]').forEach(r=>{
    r.checked = (r.value === state.sortMode);
  });
  // Years
  els.yearFrom.value = String(state.yearFrom);
  els.yearTo.value = String(state.yearTo);
}

function applyFiltersFromDialog(){
  const newTypes = new Set();
  els.filterTypes.querySelectorAll('input[type=checkbox]:checked').forEach(cb=>newTypes.add(cb.value));
  const newSubs = new Set();
  els.filterSubsets.querySelectorAll('input[type=checkbox]:checked').forEach(cb=>newSubs.add(cb.value));
  state.types = newTypes;
  state.subsets = newSubs;
  // Years
  const yf = parseInt(els.yearFrom.value,10), yt = parseInt(els.yearTo.value,10);
  state.yearFrom = isNaN(yf)? state.minYear : Math.max(state.minYear, Math.min(yf, state.maxYear));
  state.yearTo   = isNaN(yt)? state.maxYear : Math.max(state.minYear, Math.min(yt, state.maxYear));
  if(state.yearFrom > state.yearTo){ const t = state.yearFrom; state.yearFrom = state.yearTo; state.yearTo = t; }
}

function applySortFromDialog(){
  const sel = els.sortDlg.querySelector('input[name=sortMode]:checked');
  if(sel) state.sortMode = sel.value;
}

/*** ====== TIP ====== ***/
function showTip(text, x, y){
  if(!text) return;
  els.tip.textContent = text;
  els.tip.setAttribute('data-show','true');
  els.tip.setAttribute('aria-hidden','false');
  positionTip(x,y);
}
function positionTip(x,y){
  const pad = 12;
  const w = els.tip.offsetWidth, h = els.tip.offsetHeight;
  let left = x + pad, top = y + pad;
  if(left + w > window.innerWidth - 8) left = x - w - pad;
  if(top + h > window.innerHeight - 8) top = y - h - pad;
  els.tip.style.left = left + 'px';
  els.tip.style.top = top + 'px';
}
function hideTip(){
  els.tip.removeAttribute('data-show');
  els.tip.setAttribute('aria-hidden','true');
}

/*** ====== DIALOG HELPERS ====== ***/
function supportsDialog(){ return typeof HTMLDialogElement !== 'undefined'; }
function openDialog(dlg){ supportsDialog()? dlg.showModal() : (dlg.open=true, dlg.style.display='block'); }
function closeDialog(dlg){ supportsDialog()? dlg.close()     : (dlg.open=false, dlg.style.display='none'); }

/*** ====== BOOT ====== ***/
async function boot(){
  const bibText = await fetch(BIB_PATH).then(r=>r.text());
  const entries = parseBibTeX(bibText);
  state.all = entries.map(bibToPub);

  initFilters(state.all);
  syncDialogChecks();
  render();

  // wire controls
  els.btnFilter.addEventListener('click', ()=>{ syncDialogChecks(); openDialog(els.filterDlg); });
  els.btnSort.addEventListener('click', ()=>{ syncDialogChecks(); openDialog(els.sortDlg); });

  els.btnApplyFilters?.closest('form')?.addEventListener('submit', (e)=>{
    e.preventDefault();
    applyFiltersFromDialog();
    closeDialog(els.filterDlg);
    render();
  });
  els.btnResetFilters.addEventListener('click', ()=>{
    state.types.clear(); state.subsets.clear();
    state.yearFrom = state.minYear; state.yearTo = state.maxYear;
    syncDialogChecks(); render();
  });
  els.btnResetYear.addEventListener('click', ()=>{
    state.yearFrom = state.minYear; state.yearTo = state.maxYear;
    syncDialogChecks();
  });

  els.btnApplySort?.closest('form')?.addEventListener('submit', (e)=>{
    e.preventDefault();
    applySortFromDialog();
    closeDialog(els.sortDlg);
    render();
  });
}

document.addEventListener('DOMContentLoaded', boot);
</script>

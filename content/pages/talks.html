---
title: "Talks & Presentations"
author_profile: true
hideTags: true
showTOC: false
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<section class="talks-root">
  <div class="talks-controls" role="region" aria-label="Talks controls">
    <button id="btnFilter" class="talks-btn"><i class="fa fa-filter" aria-hidden="true"></i> Filter</button>
    <button id="btnSort" class="talks-btn"><i class="fa fa-sort" aria-hidden="true"></i> Sort</button>
    <span id="countLabel" class="talks-count" aria-live="polite"></span>
  </div>

  <div id="activeFilters" class="active-filters" aria-live="polite"></div>
  <ol id="talksList" class="talks-list" reversed></ol>

  <!-- Filter dialog -->
  <dialog id="filterDialog" aria-label="Filter talks">
    <form method="dialog" class="dialog-form">
      <h3>Filter</h3>

      <fieldset class="filter-group">
        <legend>Type</legend>
        <div id="filterTypes" class="filter-chips"><!-- Invited/Contributed/Poster/Other --></div>
      </fieldset>

      <fieldset class="filter-group">
        <legend>Modality</legend>
        <div id="filterModality" class="filter-chips">
          <label class="chip-toggle"><input type="checkbox" value="Online"> Online</label>
          <label class="chip-toggle"><input type="checkbox" value="In-person"> In-person</label>
          <label class="chip-toggle"><input type="checkbox" value="Hybrid"> Hybrid</label>
        </div>
      </fieldset>

      <fieldset class="filter-group">
        <legend>Continent</legend>
        <div id="filterContinents" class="filter-chips"><!-- populated --></div>
      </fieldset>

      <fieldset class="filter-group">
        <legend>Country</legend>
        <input id="countryContains" type="text" placeholder="Contains… (e.g., Japan)" style="width:100%;padding:.4rem .6rem;border-radius:.5rem;border:1px solid var(--border);"/>
      </fieldset>

      <fieldset class="filter-group">
        <legend>Year</legend>
        <div class="year-row">
          <label>From&nbsp;<input id="yearFrom" type="number" step="1" min="1900" style="width:7rem"></label>
          <label>To&nbsp;<input id="yearTo" type="number" step="1" min="1900" style="width:7rem"></label>
          <button id="btnResetYear" type="button" class="talks-btn talks-btn-secondary" style="margin-left:auto">Reset year</button>
        </div>
      </fieldset>

      <div class="dialog-actions">
        <button value="cancel" class="talks-btn talks-btn-secondary">Close</button>
        <button id="btnResetFilters" type="button" class="talks-btn talks-btn-secondary">Reset all</button>
        <button id="btnApplyFilters" type="submit" class="talks-btn talks-btn-primary">Apply</button>
      </div>
    </form>
  </dialog>

  <!-- Sort dialog -->
  <dialog id="sortDialog" aria-label="Sort talks">
    <form method="dialog" class="dialog-form">
      <h3>Sort</h3>
      <fieldset class="filter-group">
        <legend>Order</legend>
        <label class="radio"><input type="radio" name="sortMode" value="date-desc" checked> Latest first</label>
        <label class="radio"><input type="radio" name="sortMode" value="date-asc"> Oldest first</label>
        <label class="radio"><input type="radio" name="sortMode" value="title-asc"> Title — A → Z</label>
        <label class="radio"><input type="radio" name="sortMode" value="title-desc"> Title — Z → A</label>
        <label class="radio"><input type="radio" name="sortMode" value="loc-asc"> Location — A → Z</label>
        <label class="radio"><input type="radio" name="sortMode" value="loc-desc"> Location — Z → A</label>
        <label class="radio"><input type="radio" name="sortMode" value="type-asc"> Type — A → Z</label>
        <label class="radio"><input type="radio" name="sortMode" value="type-desc"> Type — Z → A</label>
      </fieldset>
      <div class="dialog-actions">
        <button value="cancel" class="talks-btn talks-btn-secondary">Close</button>
        <button id="btnApplySort" type="submit" class="talks-btn talks-btn-primary">Apply</button>
      </div>
    </form>
  </dialog>

  <details id="talks-debug" style="display:none;margin-top:1rem;"><summary>Debug</summary><pre id="talks-debug-pre" style="white-space:pre-wrap"></pre></details>
</section>

<style>
  /* --- Theme tokens scoped to this page (defaults = light) --- */
  .talks-root{
    --bg:#fff; --fg:#24292f; --muted:#555;
    --chip-bg:#fff; --chip-fg:inherit; --chip-border:#d0d7de;
    --btn-bg:#fff; --btn-fg:#24292f; --btn-border:#d0d7de; --btn-bg-hover:#f6f8fa;
    --border:#d0d7de;
    color: var(--fg);
  }
  /* OS dark or site dark flips tokens */
  @media (prefers-color-scheme: dark){
    .talks-root{
      --bg:#161b22; --fg:#c9d1d9; --muted:#c9d1d9;
      --chip-bg:transparent; --chip-fg:inherit; --chip-border:#30363d;
      --btn-bg:#161b22; --btn-fg:#ffffff; --btn-border:#30363d; --btn-bg-hover:#0d1117;
      --border:#30363d;
    }
  }
  html.dark .talks-root, :root[data-theme="dark"] .talks-root, body.dark .talks-root{
    --bg:#161b22; --fg:#c9d1d9; --muted:#c9d1d9;
    --chip-bg:transparent; --chip-fg:inherit; --chip-border:#30363d;
    --btn-bg:#161b22; --btn-fg:#ffffff; --btn-border:#30363d; --btn-bg-hover:#0d1117;
    --border:#30363d;
  }

  .talks-controls{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin:0 0 1rem 0}
  .talks-btn{border:1px solid var(--btn-border);padding:.4rem .7rem;border-radius:.5rem;background:var(--btn-bg);color:var(--btn-fg);cursor:pointer;font:inherit}
  .talks-btn:hover{background:var(--btn-bg-hover)}
  .talks-btn-primary{background:#1f6feb;color:#fff;border-color:#1f6feb}
  .talks-btn-secondary{background:var(--btn-bg);color:var(--btn-fg)}
  .talks-count{margin-left:auto;font-size:.95rem;color:var(--muted)}

  .active-filters{display:flex;flex-wrap:wrap;gap:.5rem;margin:.25rem 0 1rem 0}
  .chip{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--chip-border);border-radius:999px;padding:.2rem .55rem;font-size:.85rem;background:var(--chip-bg);color:var(--chip-fg)}
  .chip button{all:unset;cursor:pointer;display:inline-flex}
  .chip .fa{font-size:.8em;color:inherit}

  .talks-list{counter-reset:none;padding-left:1.2rem}
  .talk-item{margin:0 0 .9rem 0;padding:0 0 .9rem 0}
  .talk-title{font-weight:600;line-height:1.35;margin:0}
  .talk-title a{color: inherit; text-decoration:none}
  .talk-title a:hover{text-decoration:underline}
  .talk-meta{margin:.15rem 0 .45rem 0;font-size:.95rem;color:var(--fg)}

  .actions{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.35rem}
  .btn-chip{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--chip-border);border-radius:.5rem;padding:.25rem .45rem;font-size:.85rem;background:var(--chip-bg);color:var(--chip-fg);text-decoration:none;line-height:1}
  .btn-chip:hover{background:var(--btn-bg-hover)}
  .btn-chip .fa{font-size:.9em;color:inherit}

  dialog{border:none;border-radius:12px;padding:1rem 1rem 1.2rem 1rem;max-width:720px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,.15);background:var(--bg);color:var(--fg)}
  .dialog-form h3{margin:.3rem 0 .7rem 0}
  .filter-group{margin:.6rem 0}
  .filter-chips{display:flex;flex-wrap:wrap;gap:.45rem}
  .chip-toggle{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--chip-border);border-radius:999px;padding:.25rem .6rem;background:var(--chip-bg);color:var(--chip-fg);cursor:pointer}
  .chip-toggle input{accent-color:#1f6feb}
  .radio{display:flex;gap:.5rem;align-items:center;margin:.25rem 0}
  .dialog-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.8rem}
  .year-row{display:flex;gap:.6rem;align-items:center}
</style>

<script>
/*** ===== Config (easy switches) ===== ***/
const DATE_STYLE = 'auto'; // 'auto' | 'jp' | 'en'

/*** ===== Sources ===== ***/
const TALKS_SOURCES = {
  "Invited": "/bib/talks-invited.bib",
  "Contributed": "/bib/talks-contributed.bib",
  "Poster": "/bib/posters.bib",
  "Other": "/bib/talks-other.bib"
};

const DEBUG = /[?&]talksdebug=1/.test(location.search);

/*** ===== Elements & State ===== ***/
const els = {
  list: document.getElementById('talksList'),
  count: document.getElementById('countLabel'),
  filterDlg: document.getElementById('filterDialog'),
  sortDlg: document.getElementById('sortDialog'),
  filterTypes: document.getElementById('filterTypes'),
  filterModality: document.getElementById('filterModality'),
  filterContinents: document.getElementById('filterContinents'),
  countryContains: document.getElementById('countryContains'),
  btnFilter: document.getElementById('btnFilter'),
  btnSort: document.getElementById('btnSort'),
  btnApplyFilters: document.getElementById('btnApplyFilters'),
  btnResetFilters: document.getElementById('btnResetFilters'),
  btnApplySort: document.getElementById('btnApplySort'),
  yearFrom: document.getElementById('yearFrom'),
  yearTo: document.getElementById('yearTo'),
  btnResetYear: document.getElementById('btnResetYear'),
  activeFilters: document.getElementById('activeFilters'),
  dbgWrap: document.getElementById('talks-debug'),
  dbg: document.getElementById('talks-debug-pre'),
};
const state = {
  all: [],
  sortMode: 'date-desc',
  types: new Set(),
  modalities: new Set(),
  continents: new Set(),
  countryContains: '',
  yearFrom: null, yearTo: null, minYear: null, maxYear: null
};

/*** ===== Debug helper ===== ***/
function logd(...a){ if(DEBUG){ console.log('[talks]',...a); els.dbgWrap.style.display='block'; els.dbg.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ')+'\n'; }}

/*** ===== Fetch & parse multiple .bib files ===== ***/
async function fetchText(url){
  const res = await fetch(url, {cache:'no-cache'});
  if(!res.ok) throw new Error('Failed '+url+' '+res.status);
  return res.text();
}
async function loadAllSources(){
  const out = [];
  for(const [kind, path] of Object.entries(TALKS_SOURCES)){
    try{
      const text = await fetchText(new URL(path, document.baseURI).href);
      const entries = parseBibTeX(text);
      entries.forEach(e => e._kind = kind);
      out.push(...entries);
      logd('Loaded', kind, 'entries:', entries.length, 'from', path);
    }catch(err){
      logd('Error loading', kind, path, String(err));
    }
  }
  return out;
}

/*** ===== BibTeX utils & parser ===== ***/
function uniqueSorted(arr){ return [...new Set(arr)].sort((a,b)=>a.localeCompare(b,'en',{sensitivity:'base'})); }
function trimBraces(str){ return (str||'').replace(/^{|}$/g,''); }
function untex(s){
  if(!s) return '';
  return s
    .replace(/\\&/g,'&').replace(/\\%/g,'%')
    .replace(/{\\\'?a}/g,'á').replace(/\\\'a/g,'á')
    .replace(/{\\\"o}/g,'ö').replace(/\\"o/g,'ö')
    .replace(/{\\\'?e}/g,'é').replace(/\\\'e/g,'é')
    .replace(/{\\\'?i}/g,'í').replace(/\\\'i/g,'í')
    .replace(/{\\\'?o}/g,'ó').replace(/\\\'o/g,'ó')
    .replace(/{\\\'?u}/g,'ú').replace(/\\\'u/g,'ú')
    .replace(/\\textendash/g,'–').replace(/\\textemdash/g,'—')
    .replace(/\$[^$]*\$/g,'')
    .replace(/[{}]/g,'')
    .replace(/\s+/g,' ')
    .trim();
}
function monthToNum(m){
  if(!m) return '';
  const s = m.toString().toLowerCase().slice(0,3);
  const map = {jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
  return map[s] || '';
}
function monthToAlpha(m){
  if(!m) return '';
  const s = m.toString().toLowerCase().slice(0,3);
  const map = {jan:'Jan',feb:'Feb',mar:'Mar',apr:'Apr',may:'May',jun:'Jun',jul:'Jul',aug:'Aug',sep:'Sep',oct:'Oct',nov:'Nov',dec:'Dec'};
  return map[s] || '';
}
function parseBibTeX(input){
  const text = input.replace(/^[ \t]*%.*$/gm,''); // strip % comments
  const strings = Object.create(null);
  const entries = [];
  let i=0;
  while(true){
    const at = text.indexOf('@', i);
    if(at === -1) break;
    const braceIdx = text.indexOf('{', at);
    const parenIdx = text.indexOf('(', at);
    let open = braceIdx, closeCh = '}';
    if(parenIdx !== -1 && (braceIdx === -1 || parenIdx < braceIdx)){ open = parenIdx; closeCh = ')'; }
    if(open === -1) break;
    const type = text.slice(at+1, open).trim().toLowerCase();
    // read block
    let depth = 0, j = open, end = -1;
    for(; j < text.length; j++){
      const ch = text[j];
      if(ch === '{' || ch==='(') depth++;
      else if(ch === '}' || ch===')'){ depth--; if(depth===0){ end = j; break; } }
    }
    if(end === -1) break;
    const body = text.slice(open+1, end).trim();
    i = end + 1;
    if(type==='comment' || type==='preamble'){ continue; }
    if(type==='string'){
      const m = body.match(/^\s*([^=]+?)\s*=\s*(.+)\s*$/s);
      if(m){
        const key = m[1].trim().toLowerCase();
        const val = parseValue(m[2].trim());
        strings[key] = val;
      }
      continue;
    }
    // normal entry
    let k=0, keyEnd=-1, d=0;
    for(; k<body.length; k++){
      const ch = body[k];
      if(ch === '{') d++;
      if(ch === '}') d--;
      if(ch === ',' && d===0){ keyEnd = k; break; }
    }
    if(keyEnd === -1) continue;
    const citekey = body.slice(0,keyEnd).trim();
    const fieldsText = body.slice(keyEnd+1).trim();
    const fields = {};
    let p=0;
    while(p < fieldsText.length){
      while(p<fieldsText.length && /[\s,]/.test(fieldsText[p])) p++;
      if(p>=fieldsText.length) break;
      const nameStart = p;
      while(p<fieldsText.length && /[A-Za-z_]/.test(fieldsText[p])) p++;
      const name = fieldsText.slice(nameStart,p).toLowerCase();
      while(p<fieldsText.length && /\s/.test(fieldsText[p])) p++;
      if(fieldsText[p] !== '='){ while(p<fieldsText.length && fieldsText[p]!==',') p++; continue; }
      p++; while(p<fieldsText.length && /\s/.test(fieldsText[p])) p++;
      const {value, next} = parseValueWithConcat(fieldsText, p, strings);
      p = next;
      fields[name] = value.trim();
    }
    entries.push({type, key: citekey, fields});
  }
  return entries;

  function parseValueWithConcat(s, idx, strings){
    const parts = [];
    let p = idx;
    while(p < s.length){
      while(p<s.length && /\s/.test(s[p])) p++;
      if(p>=s.length) break;
      let {value, next} = parseValueToken(s, p, strings);
      parts.push(value);
      p = next;
      while(p<s.length && /\s/.test(s[p])) p++;
      if(s[p] === '#'){ p++; continue; }
      break;
    }
    while(p<s.length && s[p]!==',') p++;
    if(p<s.length && s[p]===',') p++;
    return {value: parts.join(''), next: p};
  }
  function parseValueToken(s, p, strings){
    if(s[p] === '{'){
      let depth=0; p++; const start=p;
      for(; p<s.length; p++){
        const ch=s[p];
        if(ch==='{') depth++;
        else if(ch==='}'){ if(depth===0){ const raw=s.slice(start,p); p++; return {value: raw, next:p}; } depth--; }
      }
      return {value:'', next:p};
    }else if(s[p] === '"'){
      p++; const start=p;
      for(; p<s.length; p++){ if(s[p]==='"' && s[p-1] !== '\\'){ const raw=s.slice(start,p); p++; return {value: raw, next:p}; } }
      return {value:'', next:p};
    }else{
      const start=p;
      while(p<s.length && /[^,\s#)}/]/.test(s[p])) p++;
      const token = s.slice(start,p).trim();
      const key = token.toLowerCase();
      const val = (strings[key] ?? token);
      return {value: val, next:p};
    }
  }
  function parseValue(val){
    val = val.trim();
    if(val.startsWith('{') || val.startsWith('"')) return trimBraces(val.replace(/^"|"$/g,''));
    const k = val.toLowerCase(); return strings[k] ?? val;
  }
}

/*** ===== Map Bib entry -> Talk item ===== ***/
function pick(...vals){ return vals.find(v => v && String(v).trim().length) || ''; }
function normalizeLocation(f){
  const loc = pick(f.address, f.location, f.venue, f.institution, f.organization, f.school, f.publisher, f.howpublished, f.note, f.place);
  return untex(trimBraces(loc)).replace(/\s+/g,' ').trim();
}
function extractCountry(loc){
  const s = (loc||'').toLowerCase();
  const parts = s.split(',').map(x=>x.trim()).filter(Boolean);
  let guess = parts[parts.length-1] || s;
  guess = guess.replace(/\busa\b|\bu\.s\.a\.\b/g,'united states').replace(/\buk\b/g,'united kingdom');
  return guess;
}
const COUNTRY_TO_CONTINENT = {
  "japan":"Asia","india":"Asia","china":"Asia","korea":"Asia","taiwan":"Asia","singapore":"Asia","thailand":"Asia","vietnam":"Asia","indonesia":"Asia",
  "usa":"North America","united states":"North America","canada":"North America","mexico":"North America",
  "united kingdom":"Europe","england":"Europe","scotland":"Europe","wales":"Europe","ireland":"Europe",
  "germany":"Europe","france":"Europe","italy":"Europe","spain":"Europe","portugal":"Europe","sweden":"Europe","norway":"Europe","finland":"Europe","denmark":"Europe","netherlands":"Europe","belgium":"Europe","switzerland":"Europe","austria":"Europe","poland":"Europe","czech":"Europe","czech republic":"Europe","slovakia":"Europe","hungary":"Europe","greece":"Europe",
  "australia":"Oceania","new zealand":"Oceania",
  "brazil":"South America","argentina":"South America","chile":"South America","peru":"South America","colombia":"South America",
  "south africa":"Africa","kenya":"Africa","egypt":"Africa","morocco":"Africa","ghana":"Africa","nigeria":"Africa",
  "israel":"Asia","turkey":"Asia"
};
function continentFromCountry(country){
  const key = (country||'').toLowerCase();
  for(const name in COUNTRY_TO_CONTINENT){ if(key.includes(name)) return COUNTRY_TO_CONTINENT[name]; }
  return '';
}
function modalityFromFields(f){
  const raw = [f.modality, f.note, f.howpublished, f.venue].filter(Boolean).join(' ').toLowerCase();
  const hasOnline = /online|virtual|zoom|youtube|livestream/.test(raw);
  const hasPlace  = /room|hall|campus|auditorium|street|city|in-person|on-site|onsite/.test(raw);
  if(/hybrid/.test(raw)) return 'Hybrid';
  if(hasOnline && hasPlace) return 'Hybrid';
  if(hasOnline) return 'Online';
  return 'In-person';
}

/* date helpers */
function formatDateLabel(y, mNum, mAlpha, d){
  const pad = n => String(n||'').padStart(2,'0');
  if(DATE_STYLE === 'jp'){
    if(y && mNum && d) return `${y}年${pad(mNum)}月${pad(d)}日`;
    if(y && mNum)      return `${y}年${pad(mNum)}月`;
    if(y)              return `${y}年`;
    return '';
  }
  if(DATE_STYLE === 'en'){
    if(y && mAlpha && d) return `${y}${mAlpha}${pad(d)}`;
    if(y && mAlpha)      return `${mAlpha} ${y}`;
    if(y)                return String(y);
    return '';
  }
  // auto
  if(y && mNum && d) return `${y}年${pad(mNum)}月${pad(d)}日`; // full JP when day exists
  if(y && mAlpha)    return `${mAlpha} ${y}`;                  // Mon YYYY otherwise
  if(y)              return String(y);
  return '';
}
function mapDate(fields){
  const y = parseInt((fields.year||'').match(/\d{4}/)?.[0]||'')||0;
  const mNum = monthToNum(fields.month||'');        // "01" .. "12"
  const mAlpha = monthToAlpha(fields.month||'');    // "Jan" etc.
  const d = parseInt((fields.day||'').toString(),10) || '';
  const dateKey = `${y || '0000'}-${mNum || '00'}-${String(d||'00').padStart(2,'0')}`;
  const label = formatDateLabel(y, mNum, mAlpha, d);
  return {year: y, dateKey, label};
}
function bibToTalk(e){
  const f = e.fields;
  const title = untex(trimBraces(f.title||'')).replace(/\s+/g,' ').trim();
  const event = untex(trimBraces(pick(f.event, f.eventtitle, f.booktitle, f.series, f.journal, f.organization, f.institution, f.school))).trim();
  const loc = normalizeLocation(f);
  const countryRaw = extractCountry(loc);
  const continent = continentFromCountry(countryRaw);
  const {year, dateKey, label: dateLabel} = mapDate(f);
  const modality = modalityFromFields(f);
  const slides = pick(f.slides, f.materials, f.presentation, f.url, f.link);
  const page = pick(f.page, f.project, f.website);
  return {
    id: e.key,
    type: e._kind || 'Other',
    title, event,
    location: loc,
    continent,
    country: untex(countryRaw).trim(),
    modality,
    year, dateKey, dateLabel,
    slides: slides || null,
    page: page || null
  };
}

/*** ===== UI helpers ===== ***/
function initFilters(talks){
  const types = ["Invited","Contributed","Poster","Other"];
  if(els.filterTypes) els.filterTypes.innerHTML = types.map(t=>`<label class="chip-toggle"><input type="checkbox" value="${t}"> ${t}</label>`).join('');
  const conts = uniqueSorted(talks.map(t=>t.continent).filter(Boolean));
  const list = conts.length ? conts : ["Africa","Asia","Europe","North America","South America","Oceania","Antarctica"];
  if(els.filterContinents) els.filterContinents.innerHTML = list.map(c=>`<label class="chip-toggle"><input type="checkbox" value="${c}"> ${c}</label>`).join('');
  const years = talks.map(t=>t.year).filter(Boolean);
  state.minYear = years.length ? Math.min(...years) : 2000;
  state.maxYear = years.length ? Math.max(...years) : new Date().getFullYear();
  state.yearFrom = state.minYear; state.yearTo = state.maxYear;
  if(els.yearFrom && els.yearTo){
    els.yearFrom.min = els.yearTo.min = String(state.minYear);
    els.yearFrom.max = els.yearTo.max = String(state.maxYear);
    els.yearFrom.value = String(state.yearFrom); els.yearTo.value = String(state.yearTo);
  }
}
function button(label, icon, url){
  if(!url) return '';
  return `<a class="btn-chip" href="${url.replace(/"/g,'%22')}" target="_blank" rel="noopener"><i class="fa ${icon}" aria-hidden="true"></i> ${label}</a>`;
}
function iconChip(label, icon){ return `<span class="btn-chip" role="note"><i class="fa ${icon}" aria-hidden="true"></i> ${label}</span>`; }
function mapsLink(q){ return 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(q); }

function renderActiveFilters(){
  if(!els.activeFilters) return;
  const chips=[];
  if(state.types.size) state.types.forEach(t=>chips.push(makeChip('Type', t, 'type', t)));
  if(state.modalities.size) state.modalities.forEach(m=>chips.push(makeChip('Mode', m, 'mod', m)));
  if(state.continents.size) state.continents.forEach(c=>chips.push(makeChip('Continent', c, 'cont', c)));
  if(state.countryContains) chips.push(makeChip('Country', state.countryContains, 'country', '1'));
  if(state.yearFrom!==state.minYear || state.yearTo!==state.maxYear){
    chips.push(`<span class="chip">Years: ${state.yearFrom}–${state.yearTo}<button aria-label="Reset years" data-x-year="1"><i class="fa fa-times"></i></button></span>`);
  }
  els.activeFilters.innerHTML = chips.join('');
  els.activeFilters.querySelectorAll('button[data-x-type]').forEach(b=>b.addEventListener('click',()=>{ state.types.delete(b.dataset.xType); syncDialogChecks(); render(); }));
  els.activeFilters.querySelectorAll('button[data-x-mod]').forEach(b=>b.addEventListener('click',()=>{ state.modalities.delete(b.dataset.xMod); syncDialogChecks(); render(); }));
  els.activeFilters.querySelectorAll('button[data-x-cont]').forEach(b=>b.addEventListener('click',()=>{ state.continents.delete(b.dataset.xCont); syncDialogChecks(); render(); }));
  els.activeFilters.querySelectorAll('button[data-x-country]').forEach(b=>b.addEventListener('click',()=>{ state.countryContains=''; if(els.countryContains) els.countryContains.value=''; render(); }));
  els.activeFilters.querySelectorAll('button[data-x-year]').forEach(b=>b.addEventListener('click',()=>{ state.yearFrom=state.minYear; state.yearTo=state.maxYear; syncDialogChecks(); render(); }));
  function makeChip(label, val, kind, data){
    return `<span class="chip">${label}: ${val}<button aria-label="Remove ${label}" data-x-${kind}="${data}"><i class="fa fa-times"></i></button></span>`;
  }
}
function passesFilters(t){
  const tOK = state.types.size ? state.types.has(t.type) : true;
  const mOK = state.modalities.size ? state.modalities.has(t.modality) : true;
  const cOK = state.continents.size ? state.continents.has(t.continent) : true;
  const cc = state.countryContains.trim().toLowerCase();
  const countryOK = cc ? (t.country||'').toLowerCase().includes(cc) : true;
  const yOK = (!state.yearFrom || !t.year || t.year >= state.yearFrom) &&
              (!state.yearTo   || !t.year || t.year <= state.yearTo);
  return tOK && mOK && cOK && countryOK && yOK;
}
function sortTalks(list){
  const m = state.sortMode;
  return [...list].sort((a,b)=>{
    if(m==='date-desc') return b.dateKey.localeCompare(a.dateKey) || a.title.localeCompare(b.title);
    if(m==='date-asc')  return a.dateKey.localeCompare(b.dateKey) || a.title.localeCompare(b.title);
    if(m==='title-asc') return a.title.localeCompare(b.title,'en',{sensitivity:'base'});
    if(m==='title-desc')return b.title.localeCompare(a.title,'en',{sensitivity:'base'});
    if(m==='loc-asc')   return (a.location||'').localeCompare((b.location||''),'en',{sensitivity:'base'});
    if(m==='loc-desc')  return (b.location||'').localeCompare((a.location||''),'en',{sensitivity:'base'});
    if(m==='type-asc')  return a.type.localeCompare(b.type);
    if(m==='type-desc') return b.type.localeCompare(a.type);
    return 0;
  });
}
function render(){
  const filtered = state.all.filter(passesFilters);
  const sorted = sortTalks(filtered);
  if(els.list) els.list.setAttribute('start', String(sorted.length));
  if(els.list) els.list.innerHTML = sorted.map(t => {
    const titleHtml = t.page ? `<a href="${t.page.replace(/"/g,'%22')}" class="title-link" target="_blank" rel="noopener">${t.title}</a>` : `${t.title}`;
    const meta = [t.event, t.type, t.modality].filter(Boolean).join(' • ');
    const actions = [
      t.location ? button(t.location, 'fa-location-dot', mapsLink(t.location)) : '',
      t.dateLabel ? iconChip(t.dateLabel, 'fa-calendar') : '',
      t.slides ? button('Slides', 'fa-file-lines', t.slides) : '',
      t.page ? button('Page', 'fa-up-right-from-square', t.page) : ''
    ].filter(Boolean).join(' ');
    return `
      <li class="talk-item">
        <p class="talk-title">${titleHtml}</p>
        <div class="talk-meta">${meta}</div>
        <div class="actions">${actions}</div>
      </li>`;
  }).join('');
  if(els.count) els.count.textContent = `Showing ${sorted.length} of ${state.all.length}`;
  renderActiveFilters();
}
function syncDialogChecks(){
  els.filterTypes?.querySelectorAll('input[type=checkbox]').forEach(cb=>{ cb.checked = state.types.has(cb.value); });
  els.filterContinents?.querySelectorAll('input[type=checkbox]').forEach(cb=>{ cb.checked = state.continents.has(cb.value); });
  els.filterModality?.querySelectorAll('input[type=checkbox]').forEach(cb=>{ cb.checked = state.modalities.has(cb.value); });
  if(els.countryContains) els.countryContains.value = state.countryContains;
  if(els.yearFrom && els.yearTo){ els.yearFrom.value = String(state.yearFrom); els.yearTo.value = String(state.yearTo); }
}

/*** ===== Boot ===== ***/
async function boot(){
  // Initial placeholder to avoid "nothing loaded" flash
  if (els.list) els.list.innerHTML = '<li class="talk-item"><em>Loading talks…</em></li>';
  if (els.count) els.count.textContent = '—';

  try{
    const rawEntries = await loadAllSources();
    if(!rawEntries.length){
      if (els.list) els.list.innerHTML = '<li class="talk-item"><em>No talks found (enable ?talksdebug=1 for details).</em></li>';
      if (els.count) els.count.textContent = 'Showing 0 of 0';
      return;
    }
    state.all = rawEntries.map(bibToTalk);
    initFilters(state.all);
    syncDialogChecks();
    render();
  }catch(e){
    if (els.list) els.list.innerHTML = `<li class="talk-item"><em>Could not load talks.</em><br><small>${String(e)}</small></li>`;
    if (els.count) els.count.textContent = '—';
    return;
  }

  // Open dialogs
  els.btnFilter?.addEventListener('click', ()=>{ syncDialogChecks(); (els.filterDlg?.showModal ? els.filterDlg.showModal() : (els.filterDlg.open = true)); });
  els.btnSort?.addEventListener('click',   ()=>{ syncDialogChecks(); (els.sortDlg?.showModal   ? els.sortDlg.showModal()   : (els.sortDlg.open = true)); });

  // Apply Filters
  els.btnApplyFilters?.closest('form')?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const newTypes = new Set(); els.filterTypes?.querySelectorAll('input[type=checkbox]:checked').forEach(cb=>newTypes.add(cb.value));
    const newMods  = new Set(); els.filterModality?.querySelectorAll('input[type=checkbox]:checked').forEach(cb=>newMods.add(cb.value));
    const newConts = new Set(); els.filterContinents?.querySelectorAll('input[type=checkbox]:checked').forEach(cb=>newConts.add(cb.value));
    state.types = newTypes; state.modalities = newMods; state.continents = newConts;
    state.countryContains = (els.countryContains?.value || '').trim();
    const yf = parseInt(els.yearFrom?.value ?? '', 10);
    const yt = parseInt(els.yearTo?.value ?? '', 10);
    state.yearFrom = Number.isFinite(yf) ? Math.max(state.minYear, Math.min(yf, state.maxYear)) : state.minYear;
    state.yearTo   = Number.isFinite(yt) ? Math.max(state.minYear, Math.min(yt, state.maxYear)) : state.maxYear;
    if (state.yearFrom > state.yearTo){ const t = state.yearFrom; state.yearFrom = state.yearTo; state.yearTo = t; }
    (els.filterDlg?.close ? els.filterDlg.close() : (els.filterDlg.open = false));
    render();
  });

  // Reset filters
  els.btnResetFilters?.addEventListener('click', ()=>{
    state.types.clear(); state.modalities.clear(); state.continents.clear();
    state.countryContains = '';
    state.yearFrom = state.minYear; state.yearTo = state.maxYear;
    syncDialogChecks(); render();
  });

  // Reset year range only
  els.btnResetYear?.addEventListener('click', ()=>{
    state.yearFrom = state.minYear; state.yearTo = state.maxYear; syncDialogChecks();
  });

  // Apply sort
  els.btnApplySort?.closest('form')?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const sel = els.sortDlg?.querySelector('input[name=sortMode]:checked');
    if (sel) state.sortMode = sel.value;
    (els.sortDlg?.close ? els.sortDlg.close() : (els.sortDlg.open = false));
    render();
  });
}
document.addEventListener('DOMContentLoaded', boot);
</script>
